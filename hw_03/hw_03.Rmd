---
title: "Third Week: Exploratory Data Analysis"
subtitle: "LaLiga Analysis"
author: "Mina Moosavifar - 93106788"
date: "`r Sys.time()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

<div align="center">
<img  src="images/laliga-lo.jpg"  align = 'center'>
</div>

<h1 dir="RTL"> 
تمرین سری سوم: از لالیگا تا لیگ برتر
</h1>

> <p dir="RTL"> 
با استفاده از داده های لیگ دسته اول اسپانیا به سوالات زیر پاسخ دهید.
از هر دو ابزار
ggplot2
و
highcharter
برای این کار تصویرسازی استفاده نمایید.
</p>

***
<p dir="RTL">

از آنجایی که برای حل سوالات نیاز به جدول لیگ در تمام سالها داریم، ابتدا بر اساس کد زیر جدول زیر را بدست میآوریم.
در این کد، برای هر فصل تعداد برد، مساوی و باخت هر تیم را بدست میآوریم و در نهایت امتیاز تیمها را محاسبه میکنیم.
همچنین لازم به ذکر است که برای نمایش تاریخ، فرمت را به فرمت 
Date
در 
R 
تبدیل میکنیم.
</p>

```{r, message=FALSE}
# making data and league table
library(devtools)
library(dplyr)
library(highcharter)
library(engsoccerdata)
library(ggplot2)

fdb = as.tbl(spain)

# creating all league table
laLiga <- fdb %>% filter(tier == 1)
laLiga$Date <- as.Date(laLiga$Date, format="%Y-%m-%d") 
#rbind two copies of the orignal df, simply reversing home/away team for each match
rbind(
  laLiga %>%
    select(Season, team = home, opp = visitor, GF = hgoal, GA = vgoal),
  laLiga %>%
    select(Season, team = visitor, opp = home, GF = vgoal, GA = hgoal)
) %>% mutate(GD = GF-GA) %>% 
  group_by(team,Season) %>% 
  summarize(GP = n(),
            goalsF = sum(GF),
            goalsA = sum(GA),
            goaldif = sum(GD),
            W = sum(GD > 0),
            D = sum(GD == 0),
            L = sum(GD < 0)
  ) %>% 
  mutate(score = W*3 + D) %>%
  arrange(Season, desc(score), desc(goaldif)) %>% 
  group_by(Season) %>% 
  mutate(rank = row_number() %>% as.integer()) -> atable
```

***

<p dir="RTL">
۱. تعداد قهرمانی های تیم ها در تاریخ لالیگا  را استخراج کرده و نمودار ستونی آنها را رسم کنید.
</p>
<p dir="RTL">
برای این نمودار ابتدا از جدول لیگ به ازای هر فصل، تیم دارای بیشترین امتیاز را انتخاب میکنیم، سپس بر اساس تیم گروهبندی کرده و تعداد رخداد هر تیم را محاسبه میکنیم.
</p>

```{r, message=FALSE, warning=FALSE}
champion_table <- atable %>% 
  group_by(Season) %>% filter(rank == 1)
champs <- champion_table %>% 
  group_by(team) %>% summarise(championships = n())

p1 = ggplot(data = champs, mapping = aes(x = team, y = championships, fill = championships)) + ggtitle("number of championships based on team") + geom_bar(stat="identity") + scale_fill_gradient(low="gold", high="darkgreen") + ylab("championship") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
p1
```

***

<p dir="RTL">
۲. کسل کننده ترین لیگ و تیم را بیابید.
نمودار ده تیم و ده فصل کسل کننده را رسم کنید.
</p>
<p dir="RTL">
**کسلکنندهترین تیمها**
<br>
برای نمایش کسلکنندهترین تیمها معیاری را برای کسلکنندگی معرفی میکنیم که آن نسبت گلهای بازیهای تیمها به تعداد بازی تیمها است. سپس بر اساس تیم گروهبندی می کنیم و میانگین نسبت کسلکنندهگی تیمها را بدست آورده و ده تیم دارای کمترین مقدار را به عنوان کسلکنندهترین تیمها انتخاب میکنیم.
</p>

```{r, message=FALSE, warning=FALSE}
# average goal per game
atable <- atable %>% mutate(goaltotgame = (goalsA + goalsF)/GP)
boring_teams <- atable %>% 
  group_by(team) %>% summarise(goaltotavg = mean(goaltotgame)) %>% 
  arrange(goaltotavg) %>% slice(1:10)

highchart() %>% 
  hc_add_series(data = boring_teams, type = "line", hcaes(x = team, y = goaltotavg), name = "Boring teams", showInLegend = FALSE) %>% 
  hc_yAxis(title = list(text = "boring rate")) %>% 
  hc_xAxis(type = 'category', title = list(categories = boring_teams$team, text = "team")) %>% 
  hc_title(text = "Most boring teams", style = list(fontWeight = "bold")) %>%
  hc_add_theme(hc_theme_flat())
```
<p dir="RTL">
**کسلکنندهترین فصلها**
<br>
برای نمایش کسلکنندهترین فصلها، ابتدا معیاری برای کسلکنندگی تعریف میکنیم که برابر است با متوسط گل زدهشده در هر بازی. برای این منظور ابتدا تعداد گل بازیها را بدستآورده و سپس برای هر فصل متوسط تعداد گلزدهشده را مییابیم و در نهایت فصل هایی که دارای کمترین متوسط گل هستند را به عنوان کسلکنندهترین فصلها انتخاب میکنیم.
</p>
```{r, message=FALSE, warning=FALSE}
# average goal per game
laLiga <- laLiga %>% mutate(totgoal = hgoal + vgoal)
boring_seasons <- laLiga %>% 
  group_by(Season) %>% 
  summarise(avggoal = mean(totgoal)) %>% 
  arrange(avggoal) %>% 
  slice(1:10)
  
highchart() %>% 
  hc_add_series(data = boring_seasons, type = "line", hcaes(x = reorder(Season, avggoal), y = avggoal), name = "Boring seasons", showInLegend = FALSE, color = "lightseagreen") %>% 
  hc_yAxis(title = list(text = "boring rate")) %>% 
  hc_xAxis(type = 'category', title = list(categories = boring_seasons$Season, text = "season")) %>% 
  hc_title(text = "Most boring teams", style = list(fontWeight = "bold")) %>%
  hc_add_theme(hc_theme_flat())
```


***
<p dir="RTL">
برای حل سوالاتی که در ادامه میآیند، جدول نتایج جدیدی میسازیم که در آن برای هر بازی و هر تیم، دادههایی همچون تیم رقیب، گل زدهشده، گل خورده، تفاضل گل، تاریخ و فصل بازی را نگهداری میکنیم.
همچنین، جدول لیگ جدیدی میسازیم که در آن در هر فصل و برای هر تیم، دادههایی از قبیل شمارهی بازی، امتیاز تجمیعی تیم تا به این بازی، تعداد گل خوردهشدهی تجمیعی، تعداد گل زدهشدهی تجمیعی و اختلاف گل تجمیعی را محاسبه میکنیم.
<br>
برای محاسبهی حاصل تجمیعی از تابع
cumsum 
و برای محاسبهی شمارهی بازی بر اساس تاریخ از تابع
dense_rank 
بهره میبریم.
</p>
```{r, message=FALSE, warning=FALSE}
# full league results
res_table <- rbind(
  laLiga %>% mutate(team = home,
                    opponent = visitor,
                    GF = hgoal,
                    GA = vgoal,
                    GD = GF-GA) ,
  laLiga %>% mutate(team = visitor,
                    opponent = home, 
                    GF = vgoal,
                    GA = hgoal,
                    GD = GF-GA)
  ) %>% select(Date, Season, team, opponent, GF, GA, GD)

all_table <- res_table %>% group_by(Season, team) %>% 
  mutate(score = ifelse(GD > 0, 3, ifelse(GD < 0, 0, 1)),
         game_nu = dense_rank(Date),
         time = Date) %>% 
  arrange(Season, team, game_nu) %>% 
  mutate(score_cum = cumsum(score),
         GF_cum = cumsum(GF),
         GA_cum = cumsum(GA),
         GD_cum = cumsum(GD)
         ) %>% 
  select(Season, team, game_nu, time, score_cum, GF_cum, GA_cum, GD_cum)

all_table <- all_table %>% ungroup() %>% group_by(Season, game_nu) %>% 
  mutate(time = min(time)) %>% ungroup() %>% group_by(Season, team)
```

***

<p dir="RTL">
۳. در چند درصد موارد قهرمان نیم فصل در پایان فصل قهرمان شده است؟
</p>
<p dir="RTL">
برای حل این سوال از جدول لیگ جدیدی که در بالا ایجاد کردیم استفاده میکنیم، که برای محاسبهی نتایج پایان فصل، بر اساس بیشترین تعداد بازی فیلتر کرده و برای بدست آوردن نتایج نیمفصل بر اساس نصف بیشترین تعداد بازی فیلتر میکنیم. در نهایت بر حسب امتیاز تجمیعی ردهبندی کرده و تیمی که بیشترین امتیاز را داشته باشد را به عنوان قهرمان فصل اعلام میکنیم.
<br>
سپس قهرمانان نیمفصل و کل فصل را با یکدیگر بر اساس فصل
inner_join 
کرده و ستون دو تیم قهرمان نیمفصل و کل فصل را در هر فصل مقایسه میکنیم. در نهایت نسبت حاصل جمع این ستون، به تعداد فصلها درصد مورد نظر را به ما میدهد.
(در این سوال برای پیادهسازی روش رتبهبندی در لالیگا، در مواردی که تیم قهرمان با تیم دوم هر امتیاز بوده است، به صورت دستی و بر اساس معیار
head to head 
قهرمان انتخاب شدهاست.)
</p>
```{r, message=FALSE, warning=FALSE, comment=NA}
# full season results
full_season <- all_table %>% 
  filter(game_nu == max(game_nu)) %>% 
  arrange(Season, desc(score_cum), desc(GD_cum)) %>% 
  group_by(Season) %>%
  mutate(rank = row_number() %>% as.integer()) 

# champions in full season
full_champions <- full_season %>% filter(rank == 1)

  
# half season results
half_season <- all_table %>% 
  filter(game_nu == floor(max(game_nu)/2)) %>% 
  arrange(Season,desc(score_cum), desc(GD_cum)) %>% 
  group_by(Season) %>% 
  mutate(rank = row_number() %>% as.integer()) 

half_champions <- half_season %>% filter(rank == 1)

tot <- all_table %>% ungroup() %>% select(Season) %>% distinct() %>% nrow()

half_full <- inner_join(half_champions, full_champions, by = "Season")

half_full <- half_full %>% mutate(same = ifelse(team.x == team.y, 1, 0))

yes <- half_full %>% ungroup() %>%  summarise(sum(same))

res <- yes*100/tot

cat("only ", res[1]$sum, "percent of half season champions are full season champions.")
```

***

<p dir="RTL">
۴. در بین سال های ۲۰۰۱ تا ۲۰۱۰ گربه سیاه تیم های بزرگ چه تیم هایی بوده است؟
</p>

***

<p dir="RTL">
۵. در تاریخ لالیگا کدام تیم رکورددار زودترین قهرمانی است؟
همچنین کدام تیم مقتدرانه ترین قهرمانی را داشته است؟
</p>

***

<p dir="RTL">
۶. طولانی ترین نوار پیروزی مساوی و شکست مال چه تیم هایی است؟
</p>

***

<p dir="RTL">
۷. زودترین سقوط مال کدام تیم بوده است؟
</p>

***

<div align="center">
<img  src="images/standings.png"  align = 'center'>
</div>

<p dir="RTL">
مانند شکل بالا تصویری از روند تغییر رتبه تیم ها در طول فصل ۱۹۹۸ رسم نمایید.
</p>
```{r, message=FALSE, warning=FALSE}
a_rank <- all_table %>% 
  group_by(Season, game_nu) %>% 
  arrange(desc(score_cum), desc(GD_cum)) %>% 
  mutate(rank = row_number() %>% as.integer())

a_rank <- a_rank %>% ungroup() %>% filter(Season == 1998) %>% arrange(time)


# team <- c("FCB", "RMA", "MLL", "VCF", "CEL", "RCD", "ESP", "ATH", "ZAR", "RSO", "BET", "VLD", "ATM", "ROV", "RAC", "ALV", "EXT", "VIL", "TEN", "SAL")
# rank <- c(1:20)
# team_names <- data.frame(team, rank)

a_rank  %>% 
  hchart(type = "line", hcaes(x = datetime_to_timestamp(time), y = rank, group = team)) %>% 
  hc_yAxis(title = list(text = "Position"), reversed = TRUE, max = 20, tickInterval = 1, min = 1,
           plotLines = list(list(color = "#FF0000", width = 2, value = 10, dashStyle = 'longdash'))
           ) %>% 
  hc_xAxis(categories = c("Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar", "Apr", "May", "Jun",
                          "Jul"), title = list(text = "date"), labels = list(format = '{value:%m-%d}')) %>% 
  hc_title(text = "Team rankings in 1998/1999", style = list(fontWeight = "bold"))
```

***

<div align="center">
<img  src="images/bd_10.gif"  align = 'center'>
</div>

<p dir="RTL">
۹. جدولی مشابه بالا برای فصل ۲۰۱۲ از  کل نتایج طراحی کنید.
</p>

```{r, message=FALSE, warning=FALSE, eval=FALSE}
league_2012 <- laLiga %>% filter(Season == 2012) %>% 
  select(home, visitor, FT, hgoal, vgoal) %>% 
  mutate(GD=hgoal-vgoal, result = ifelse(GD > 0, "H", ifelse(GD < 0, "A", "D")))

team_pos <- full_season %>% ungroup() %>% filter(Season == 2012) %>% 
  select(team, rank)

league_2012 <- league_2012 %>% left_join(team_pos, by = c("home" = "team"))

league_2012$home <- factor(league_2012$home, levels=rev(team_pos$team))
league_2012$visitor <- factor(league_2012$visitor, levels=team_pos$team)

league_2012$title <- "Spain laLiga 2012/2013 - RESULTS MATRIX"

matrix <- ggplot(league_2012, aes(visitor, home, fill = factor(result))) + 
  geom_tile(colour="steelblue4", size=1.5, stat="identity", height=1, width=1) + 
  geom_text(data=league_2012, aes(visitor, home, label = FT), color="black", size=rel(2)) +
  scale_x_discrete(expand = c(0, 0), position = "top") +
  scale_y_discrete(expand = c(0, 0)) +
  xlab("") + 
  ylab("") +
  facet_grid(. ~ title) +
  theme(
    strip.background = element_rect(fill="darkblue"),
    strip.text = element_text(size=15, colour="white"),
    strip.placement = "outside",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(fill=NA,color="steelblue4", size=0.5, linetype="solid"),
    axis.line = element_blank(),
    axis.ticks = element_blank(), 
    axis.text = element_text(color="white", size=rel(1)),
    panel.background = element_rect(fill="darkblue"),
    plot.background = element_rect(fill="steelblue4"),
    legend.position = "none",
    axis.text.x  = element_text(angle=75, vjust=0.5, hjust=0)        
  ) 
matrix
```

<div align="center">
<img  src="images/Rplot.svg"  align = 'center'>
</div>
***

<p dir="RTL">
۱۰. سه آماره به همراه نمودار فردوسی پسند استخراج کنید.
</p>
