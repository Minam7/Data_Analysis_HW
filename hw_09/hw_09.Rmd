---
title: "Tenth Week: Principal Component Analysis and Factor Analysis"
subtitle: "PCA Stock, image, ..."
author: "Mina Moosavi - 93106788ر"
date: "`r Sys.time()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

<div align="center">
<img  src="images/stock.jpg"  align = 'center'>
</div>

> <p dir="RTL"> 
با استفاده از داده های OHLCV شرکت های تشکیل دهنده شاخص s&p500 و همچنین داده مربوط به شاخص های اقتصادی به سوالات زیر پاسخ دهید.
</p>

***
<p dir="RTL">
بارگزاری داده ها و کتابخانه ها:
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}
library(readr)
library(dplyr)
library(stringr)
library(ggplot2)
library(highcharter)

name = list.files("data/stock_dfs/") %>% str_replace(".csv", "")
textpath = list.files("data/stock_dfs/", full.names = T)

.data <- read_csv(textpath[1]) %>% select(Date, Open, Close, Volume)
.data$stock_name = name[1]
sp500 = .data

for( i in 2:length(name)){
  .data <- read_csv(textpath[i]) %>% select(Date, Open, Close, Volume)
  .data$stock_name = name[i]
  sp500 = bind_rows(sp500, .data)
}

sp500 <- sp500 %>% mutate(
                 Year = as.numeric(format(Date, format = "%Y")),
                 Month = as.numeric(format(Date, format = "%m")),
                 Day = as.numeric(format(Date, format = "%d")),
                 Open = as.numeric(Open), 
                 Close = as.numeric(Close), 
                 Volume = as.numeric(Volume))

indexes <- read_csv("data/indexes.csv")

sector <- read_csv("data/constituents.csv")
```

<p dir="RTL">
برای ادغام داده های شرکت های مختلف در یک فایل، آن ها را به صورت افقی به یکدیگر اضافه می کنیم و معیار نام شرکت به داده ها اضافه می کنیم. در نهایت نیز تاریخ را به معیارهای آن تجزیه می کنیم.
</p>

***

<p dir="RTL">
۱. چه شرکتی رکورددار کسب بیشترین سود در بازه یکساله، دو ساله و پنج ساله می باشد؟ این سوال را برای بخش های مختلف مورد مطالعه قرار دهید و رکورددار را معرفی کنید. (برای این کار به ستون sector داده constituents مراجعه کنید.) برای هر دو قسمت نمودار سود ده شرکت و یا بخش برتر را رسم نمایید.
</p>

<p dir="RTL">
برای این سوال، درصد سود را به صورت سالیانه و دوساله و پنج ساله حساب می کنیم و بیشترین درصد سود را نمایش می دهیم.
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}
sp500 <- sp500 %>% inner_join(sector, by = c("stock_name" = "Symbol"))

# Annual
stock_yearly <- full_join(
  sp500 %>% group_by(stock_name, Year) %>% arrange(Month, Day) %>% slice(1) %>% summarise(Start = Close, Sector = Sector),
  sp500 %>% group_by(stock_name, Year) %>% arrange(-Month, -Day) %>% slice(1) %>% summarise(End = Close, Sector = Sector),
  by = c("stock_name", "Year", "Sector")
) %>% select(Year, stock_name, Start, End, Sector)

stock_yearly <- stock_yearly %>% mutate(profit = 100*((End - Start)/Start)) %>% ungroup()
```

<p dir="RTL">
بیشتر سود در یک سال)
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}
knitr::kable(stock_yearly %>% arrange(desc(profit)) %>% slice(1))
```

<p dir="RTL">
بیشترین سود سالانه در هر بخش)
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}
knitr::kable(stock_yearly %>% group_by(Sector) %>% arrange(desc(profit)) %>% slice(1))

stock_yearly %>% group_by(Sector) %>% arrange(desc(profit)) %>% slice(1) %>% 
  hchart(type = "column", hcaes(x = stock_name, y = profit, group = Sector)) %>% 
  hc_yAxis(title = list(text = "Profit Percentage")) %>% 
  hc_xAxis(type = 'category', title = list(categories = stock_yearly$stock_name, text = "Stock Name")) %>% 
  hc_title(text = "Top Annual Profitable Stocks", style = list(fontWeight = "bold")) %>% 
  hc_add_theme(hc_theme_flat())
```

```{r, message=FALSE, warning=FALSE, comment=NA}
# Every Two Year
stock_yearly$two_year_profit = 0

for (i in name) {
  stock = stock_yearly %>% filter(stock_name == i)
  for (j in 1:nrow(stock)) {
    if (j != 1) {
      # profit for other years!
      stock_yearly[stock_yearly$stock_name == i & stock_yearly$Year == stock[j,]$Year,]$two_year_profit = 100*((stock[j,]$End - stock[j - 1,]$Start)/stock[j - 1,]$Start)
    }
  }
}
```

<p dir="RTL">
بیشترین سود در بازه ی دو ساله)
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}
knitr::kable(stock_yearly %>% arrange(desc(two_year_profit)) %>% slice(1))
```

<p dir="RTL">
بیشترین سود در هر بخش در بازه ی دو ساله)
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}
knitr::kable(stock_yearly %>% group_by(Sector) %>% arrange(desc(two_year_profit)) %>% slice(1))

stock_yearly %>% group_by(Sector) %>% arrange(desc(two_year_profit)) %>% slice(1) %>% 
  hchart(type = "column", hcaes(x = stock_name, y = two_year_profit, group = Sector)) %>% 
  hc_yAxis(title = list(text = "Profit Percentage")) %>% 
  hc_xAxis(type = 'category', title = list(categories = stock_yearly$stock_name, text = "Stock Name")) %>% 
  hc_title(text = "Top Two Year Profitable Stocks", style = list(fontWeight = "bold")) %>% 
  hc_add_theme(hc_theme_538())
```

```{r, message=FALSE, warning=FALSE, comment=NA}
# Every Five Year
stock_yearly$five_year_profit = 0

for (i in name) {
  stock = stock_yearly %>% filter(stock_name == i)
  for (j in 1:nrow(stock)) {
    if (j > 4) {
      # profit for other years!
      stock_yearly[stock_yearly$stock_name == i & stock_yearly$Year == stock[j,]$Year,]$five_year_profit = 100*((stock[j,]$End - stock[j - 4,]$Start)/stock[j - 4,]$Start)
    }
  }
}
```

<p dir="RTL">
بیشترین سود در بازه ی پنج ساله)
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}
knitr::kable(stock_yearly %>% arrange(desc(five_year_profit)) %>% slice(1))
```

<p dir="RTL">
بیشترین سود در هر بخش در بازه ی پنج ساله)
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}
knitr::kable(stock_yearly %>% group_by(Sector) %>% arrange(desc(five_year_profit)) %>% slice(1))

stock_yearly %>% group_by(Sector) %>% arrange(desc(five_year_profit)) %>% slice(1) %>% 
  hchart(type = "column", hcaes(x = stock_name, y = five_year_profit, group = Sector)) %>% 
  hc_yAxis(title = list(text = "Profit Percentage")) %>% 
  hc_xAxis(type = 'category', title = list(categories = stock_yearly$stock_name, text = "Stock Name")) %>% 
  hc_title(text = "Top Five Year Profitable Stocks", style = list(fontWeight = "bold")) %>% 
  hc_add_theme(hc_theme_elementary())
```

***

<p dir="RTL">
۲. یک اعتقاد خرافی می گوید خرید سهام در روز سیزدهم ماه زیان آور است. این گزاره را مورد ارزیابی قرار دهید.
</p>

<p dir="RTL">
برای تست این موضوع، ابتدا میزان سود را به ازای تمامی شرکت ها در تمامی روزها حساب می کنیم. سپس برای هر روز نرخی به نام شکست تعریف می کنیم که برابر با نسبت تعداد شرکت های دارای افت سهام به تعداد کلی شرکت ها است. در نهایت روز ۱۳ ام ماه را از سایر روزها جدا می کنیم و بین این دو گروه آزمون فرض انجام می دهیم. در این آزمون فرض صفر را برابر بودن نرخ شکست در ۱۳ ام ماه و سایر روزها در نظر میگیریم.
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}
sp500 <- sp500 %>% mutate(profit = 100*((Close - Open)/Open))

non_profit_range <- sp500 %>% filter(profit < 0) %>% group_by(Year, Month, Day) %>% summarise(damage_rate = n()/505)

thirteen <- non_profit_range %>% filter(Day == 13)
non_thirteen <- non_profit_range %>% filter(Day != 13)

t.test(thirteen$damage_rate, non_thirteen$damage_rate, alt = "two.sided")

```

<p dir="RTL">
همانطور که نتیجه ی بالا نشان می دهد، فرض یکسان بودن عملکرد در سیزدهم ماه با سایر روزها رد نمی شود، پس نمی توانیم فرض خرافی را قبول کنیم.
</p>

***

<p dir="RTL">
۳. رکورد بیشترین گردش مالی در تاریخ بورس برای چه روزی بوده است و چرا!!!
</p>

<p dir="RTL">
معیار گردش مالی را مجموع تعداد سهام مبادله شده ی تمامی شرکت ها در نظر میگیریم. در این صورت خروجی به شکل زیر می شود:
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}
max_flow <- sp500 %>%
  group_by(Date) %>% 
  summarise(flow = sum(Volume)) %>% 
  arrange(desc(flow)) %>% slice(1:4)

knitr::kable(max_flow)
```

<p dir="RTL">
همانطور که مشاهده می کنیم، بیشترین معامله در روز ۸ اکتبر سال ۲۰۰۸ بوده است که این روز در دوران [رکود اقتصادی آمریکا](https://en.wikipedia.org/wiki/Stock_market_crash#Crash_of_2008%E2%80%932009)
قرار دارد. علت رخداد این رکود از بین رفتن حباب ۸ تریلیون دلاری مسکن بود که با عواملی همچون [مشکلات بانکی](https://www.thebalance.com/subprime-mortgage-crisis-effect-and-timeline-3305745)
و رد لایحه کمک بانکی از طرف کنگره تشدید شد.
<br>
البته همانطور که مشاهده می کنیم، بیشترین سقوط پس از آن نیز در تاریخ ۸ آگوست سال ۲۰۱۱ بوده است. علت وقوع این سقوط نیز این بود که 
s&p
میزان اعتبار بازار آمریکا را از 
AAA 
به 
AA+
تنزل داد.
</p>

***

<p dir="RTL">
۴. شاخص AAPL که نماد شرکت اپل است را در نظر بگیرید. با استفاده از رگرسیون خطی یک پیش کننده قیمت شروع (open price) بر اساس k روز قبل بسازید. بهترین انتخاب برای k چه مقداری است؟ دقت پیش بینی شما چقدر است؟
</p>

<p dir="RTL">
برای حل این سوال، ستون های روزهای قبل را به داده ها اضافه می کنیم و مدل های مختلفی با تعداد روزهای مختلفی لرن کرده و دقت آن را بوسیله
r.squared 
بدست می آوریم.
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}
appl <- sp500 %>% filter(stock_name == "AAPL") %>% arrange(desc(Date)) %>% 
  select(-stock_name, -Name, -Sector, -Volume, -Close)


# k = 1
appl$k1 = c(appl[-c(1),]$Open, 0)
lm = lm(data = appl, formula = Open~k1)
ans <- data.frame(1, summary(lm)$r.squared)
names(ans)<-c("k","R Squared")

# k = 2
appl$k2 = c(appl[-c(1,2),]$Open, 0,0)
lm = lm(data = appl, formula = Open~k1+k2)
ans_1 <- data.frame(2, summary(lm)$r.squared)
names(ans_1)<-c("k","R Squared")
ans <- ans %>% rbind(ans_1)

# k = 3
appl$k3 = c(appl[-c(1,2,3),]$Open, 0,0,0)
lm = lm(data = appl, formula = Open~k1+k2+k3)
ans_1 <- data.frame(3, summary(lm)$r.squared)
names(ans_1)<-c("k","R Squared")
ans <- ans %>% rbind(ans_1)

# k = 4
appl$k4 = c(appl[-c(1,2,3,4),]$Open, 0,0,0,0)
lm = lm(data = appl, formula = Open~k1+k2+k3+k4)
ans_1 <- data.frame(4, summary(lm)$r.squared)
names(ans_1)<-c("k","R Squared")
ans <- ans %>% rbind(ans_1)

# k = 5
appl$k5 = c(appl[-c(1,2,3,4,5),]$Open, 0,0,0,0,0)
lm = lm(data = appl, formula = Open~k1+k2+k3+k4+k5)
ans_1 <- data.frame(5, summary(lm)$r.squared)
names(ans_1)<-c("k","R Squared")
ans <- ans %>% rbind(ans_1)

# k = 6
appl$k6 = c(appl[-c(1,2,3,4,5,6),]$Open, 0,0,0,0,0,0)
lm = lm(data = appl, formula = Open~k1+k2+k3+k4+k5+k6)
ans_1 <- data.frame(6, summary(lm)$r.squared)
names(ans_1)<-c("k","R Squared")
ans <- ans %>% rbind(ans_1)

# k = 7
appl$k7 = c(appl[-c(1,2,3,4,5,6,7),]$Open, 0,0,0,0,0,0,0)
lm = lm(data = appl, formula = Open~k1+k2+k3+k4+k5+k6+k7)
ans_1 <- data.frame(7, summary(lm)$r.squared)
names(ans_1)<-c("k","R Squared")
ans <- ans %>% rbind(ans_1)

# k = 8
appl$k8 = c(appl[-c(1,2,3,4,5,6,7,8),]$Open, 0,0,0,0,0,0,0,0)
lm = lm(data = appl, formula = Open~k1+k2+k3+k4+k5+k6+k7+k8)
ans_1 <- data.frame(8, summary(lm)$r.squared)
names(ans_1)<-c("k","R Squared")
ans <- ans %>% rbind(ans_1)

# k = 9
appl$k9 = c(appl[-c(1,2,3,4,5,6,7,8,9),]$Open, 0,0,0,0,0,0,0,0,0)
lm = lm(data = appl, formula = Open~k1+k2+k3+k4+k5+k6+k7+k8+k9)
ans_1 <- data.frame(9, summary(lm)$r.squared)
names(ans_1)<-c("k","R Squared")
ans <- ans %>% rbind(ans_1)

# k = 10
appl$k10 = c(appl[-c(1,2,3,4,5,6,7,8,9,10),]$Open, 0,0,0,0,0,0,0,0,0,0)
lm = lm(data = appl, formula = Open~k1+k2+k3+k4+k5+k6+k7+k8+k9+k10)
ans_1 <- data.frame(10, summary(lm)$r.squared)
names(ans_1)<-c("k","R Squared")
ans <- ans %>% rbind(ans_1)

knitr::kable(ans)
```

<p dir="RTL">
همانطور که در بالا مشاهده می کنیم، هر چه تعداد روز بیشتری را به مدل اضافه می کنیم، دقت مدل بیشتر می شود.
</p>

***

<p dir="RTL">
۵. بر روی داده های قیمت شروع شرکت ها الگوریتم pca را اعمال کنید. نمودار تجمعی درصد واریانس بیان شده در مولفه ها را رسم کنید. سه مولفه اول چند درصد از واریانس را تبیین می کند؟
</p>

<p dir="RTL">
از آنجایی که به منظور راحتی تحلیل مکاشفه ای، داده ها را به صورت ردیفی اضافه کرده بودیم، ابتدا برای این سوال داده را به شکل مناسب در آورده و سپس 
pca 
را اعمال می کنیم.
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}
# make data ready
.data <- read_csv(textpath[1]) %>% select(Date, Open)
colnames(.data) =c("Date", name[1])
sp500_pca = .data

for(i in 2:length(name)){
  .data <- read_csv(textpath[i]) %>% select(Date, Open)
  colnames(.data) =c("Date", name[i])
  sp500_pca = merge(sp500_pca, .data)
}

# pca
stock_pca = prcomp(sp500_pca %>% select(-Date), scale. = TRUE)

plot(summary(stock_pca)$importance[3,], type="l",
     ylab="% variance explained", xlab="nth component (decreasing order)") + 
  abline(h=0.98,col="red");abline(v = 25,col="red",lty=3)

sum((stock_pca$sdev^2)[1:3])/sum((stock_pca$sdev^2))
```

***

<p dir="RTL">
۶. برای هر نماد اطلاعات بخش مربوطه را از داده constituents استخراج نمایید. برای هر بخش میانگین روزانه قیمت شروع شرکت های آن را محاسبه کنید. سپس با استفاده از میانگین به دست آمده  داده ایی با چند ستون که هر ستون یک بخش و هر سطر یک روز هست بسازید. داده مربوط را با داده شاخص های اقتصادی ادغام کنید. بر روی این داده pca بزنید و نمودار biplot آن را تفسیر کنید.
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}

```

<p dir="RTL">

</p>

***

<p dir="RTL">
۷. روی همه اطلاعات (OHLCV) سهام اپل الگوریتم PCA را اعمال کنید. سپس از مولفه اول برای پیش بینی قیمت شروع سهام در روز آینده استفاده کنید. به سوالات سوال ۴ پاسخ دهید. آیا استفاده از مولفه اول نتیجه بهتری نسبت به داده open price برای پیش بینی قیمت دارد؟
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}

```

<p dir="RTL">

</p>

***

<p dir="RTL">
۸. نمودار سود نسبی شاخص s&p500 را رسم کنید. آیا توزیع سود نرمال است؟(از داده indexes استفاده کنید.)
با استفاده از ده مولفه اول سوال پنج آیا می توانید سود و ضرر شاخص s&p500 را برای روز آينده پیش بینی کنید؟ از یک مدل رگرسیون لاجستیک استفاده کنید. درصد خطای پیش بینی را به دست آورید.
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}

```

<p dir="RTL">

</p>

***

<p dir="RTL"> 
۹. عکسی که در ابتدای متن آمده را در نظر بگیرید. با استفاده از pca عکس را فشرده کنید. سپس نمودار حجم عکس فشرده بر حسب تعداد مولفه اصلی را  رسم کنید. بهترین انتخاب برای انتخاب تعداد مولفه ها در جهت فشرده سازی چه عددی است؟
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}

```

<p dir="RTL">

</p>

***

<p dir="RTL"> 
۱۰. پنج ایده جالبی که روی داده های مالی بالا می توانستیم پیاده کنیم را بیان کنید. (ایده کافی است نیازی به محاسبه بر روی داده نیست.)
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}

```

<p dir="RTL">

</p>

