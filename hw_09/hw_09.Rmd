---
title: "Tenth Week: Principal Component Analysis and Factor Analysis"
subtitle: "PCA Stock, image, ..."
author: "Mina Moosavi - 93106788ر"
date: "`r Sys.time()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

<div align="center">
<img  src="images/stock.jpg"  align = 'center'>
</div>

> <p dir="RTL"> 
با استفاده از داده های OHLCV شرکت های تشکیل دهنده شاخص s&p500 و همچنین داده مربوط به شاخص های اقتصادی به سوالات زیر پاسخ دهید.
</p>

***
<p dir="RTL">
بارگزاری داده ها و کتابخانه ها:
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}
library(readr)
library(dplyr)
library(stringr)
library(ggplot2)
library(highcharter)

name = list.files("data/stock_dfs/") %>% str_replace(".csv", "")
textpath = list.files("data/stock_dfs/", full.names = T)

.data <- read_csv(textpath[1]) %>% select(Date, Open, Close, Volume)
.data$stock_name = name[1]
sp500 = .data

for( i in 2:length(name)){
  .data <- read_csv(textpath[i]) %>% select(Date, Open, Close, Volume)
  .data$stock_name = name[i]
  sp500 = bind_rows(sp500, .data)
}

sp500 <- sp500 %>% mutate(
                 Year = as.numeric(format(Date, format = "%Y")),
                 Month = as.numeric(format(Date, format = "%m")),
                 Day = as.numeric(format(Date, format = "%d")),
                 Open = as.numeric(Open), 
                 Close = as.numeric(Close), 
                 Volume = as.numeric(Volume))

indexes <- read_csv("data/indexes.csv")

sector <- read_csv("data/constituents.csv")
```

<p dir="RTL">
برای ادغام داده های شرکت های مختلف در یک فایل، آن ها را به صورت افقی به یکدیگر اضافه می کنیم و معیار نام شرکت به داده ها اضافه می کنیم. در نهایت نیز تاریخ را به معیارهای آن تجزیه می کنیم.
</p>

***

<p dir="RTL">
۱. چه شرکتی رکورددار کسب بیشترین سود در بازه یکساله، دو ساله و پنج ساله می باشد؟ این سوال را برای بخش های مختلف مورد مطالعه قرار دهید و رکورددار را معرفی کنید. (برای این کار به ستون sector داده constituents مراجعه کنید.) برای هر دو قسمت نمودار سود ده شرکت و یا بخش برتر را رسم نمایید.
</p>

***

<p dir="RTL">
۲. یک اعتقاد خرافی می گوید خرید سهام در روز سیزدهم ماه زیان آور است. این گزاره را مورد ارزیابی قرار دهید.
</p>

***

<p dir="RTL">
۳. رکورد بیشترین گردش مالی در تاریخ بورس برای چه روزی بوده است و چرا!!!
</p>

<p dir="RTL">
معیار گردش مالی را مجموع تعداد سهام مبادله شده ی تمامی شرکت ها در نظر میگیریم. در این صورت خروجی به شکل زیر می شود:
</p>

```{r, message=FALSE, warning=FALSE, comment=NA}
max_flow <- sp500 %>%
  group_by(Date) %>% 
  summarise(flow = sum(Volume)) %>% 
  arrange(desc(flow)) %>% slice(1:4)

knitr::kable(max_flow)
```

<p dir="RTL">
همانطور که مشاهده می کنیم، بیشترین معامله در روز ۸ اکتبر سال ۲۰۰۸ بوده است که این روز در دوران [رکود اقتصادی آمریکا](https://en.wikipedia.org/wiki/Stock_market_crash#Crash_of_2008%E2%80%932009)
قرار دارد. علت رخداد این رکود از بین رفتن حباب ۸ تریلیون دلاری مسکن بود که با عواملی همچون [مشکلات بانکی](https://www.thebalance.com/subprime-mortgage-crisis-effect-and-timeline-3305745)
و رد لایحه کمک بانکی از طرف کنگره تشدید شد.
<br>
البته همانطور که مشاهده می کنیم، بیشترین سقوط پس از آن نیز در تاریخ ۸ آگوست سال ۲۰۱۱ بوده است. علت وقوع این سقوط نیز این بود که 
s&p
میزان اعتبار بازار آمریکا را از 
AAA 
به 
AA+
تنزل داد.
</p>

***

<p dir="RTL">
۴. شاخص AAPL که نماد شرکت اپل است را در نظر بگیرید. با استفاده از رگرسیون خطی یک پیش کننده قیمت شروع (open price) بر اساس k روز قبل بسازید. بهترین انتخاب برای k چه مقداری است؟ دقت پیش بینی شما چقدر است؟
</p>


***

<p dir="RTL">
۵. بر روی داده های قیمت شروع شرکت ها الگوریتم pca را اعمال کنید. نمودار تجمعی درصد واریانس بیان شده در مولفه ها را رسم کنید. سه مولفه اول چند درصد از واریانس را تبیین می کند؟
</p>

***

<p dir="RTL">
۶. برای هر نماد اطلاعات بخش مربوطه را از داده constituents استخراج نمایید. برای هر بخش میانگین روزانه قیمت شروع شرکت های آن را محاسبه کنید. سپس با استفاده از میانگین به دست آمده  داده ایی با چند ستون که هر ستون یک بخش و هر سطر یک روز هست بسازید. داده مربوط را با داده شاخص های اقتصادی ادغام کنید. بر روی این داده pca بزنید و نمودار biplot آن را تفسیر کنید.
</p>

***

<p dir="RTL">
۷. روی همه اطلاعات (OHLCV) سهام اپل الگوریتم PCA را اعمال کنید. سپس از مولفه اول برای پیش بینی قیمت شروع سهام در روز آینده استفاده کنید. به سوالات سوال ۴ پاسخ دهید. آیا استفاده از مولفه اول نتیجه بهتری نسبت به داده open price برای پیش بینی قیمت دارد؟
</p>

***

<p dir="RTL">
۸. نمودار سود نسبی شاخص s&p500 را رسم کنید. آیا توزیع سود نرمال است؟(از داده indexes استفاده کنید.)
با استفاده از ده مولفه اول سوال پنج آیا می توانید سود و ضرر شاخص s&p500 را برای روز آينده پیش بینی کنید؟ از یک مدل رگرسیون لاجستیک استفاده کنید. درصد خطای پیش بینی را به دست آورید.
</p>

***

<p dir="RTL"> 
۹. عکسی که در ابتدای متن آمده را در نظر بگیرید. با استفاده از pca عکس را فشرده کنید. سپس نمودار حجم عکس فشرده بر حسب تعداد مولفه اصلی را  رسم کنید. بهترین انتخاب برای انتخاب تعداد مولفه ها در جهت فشرده سازی چه عددی است؟
</p>

***

<p dir="RTL"> 
۱۰. پنج ایده جالبی که روی داده های مالی بالا می توانستیم پیاده کنیم را بیان کنید. (ایده کافی است نیازی به محاسبه بر روی داده نیست.)
</p>

